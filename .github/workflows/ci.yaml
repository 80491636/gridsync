on: [push]

jobs:
  Linux:
    strategy:
      fail-fast: false
      matrix:
        # https://docs.github.com/en/actions/reference/specifications-for-github-hosted-runners
        # [ubuntu-16.04, ubuntu-18.04, ubuntu-20.04, macos-10.15, windows-2019]
        os:
          - runs-on: ubuntu-20.04
          - runs-on: ubuntu-18.04
          - runs-on: ubuntu-16.04
    runs-on: ${{ matrix.os.runs-on }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Restore pyenv cache
      uses: actions/cache@v2
      with:
        path: ~/.pyenv
        key: pyenv-${{ matrix.os.runs-on }}
        restore-keys: pyenv-${{ matrix.os.runs-on }}
    - name: Restore cargo cache
      uses: actions/cache@v2
      with:
        path: ~/.cargo
        key: cargo-${{ matrix.os.runs-on }}
        restore-keys: cargo-${{ matrix.os.runs-on }}
    - name: Install dependencies
      run: |
        scripts/provision_devtools.sh
    - name: Test
      run: |
        env | sort
        cat ~/.bash_profile
        source ~/.bash_profile
        env | sort
        make test
    - name: Build
      run: |
        env | sort
        cat ~/.bash_profile
        source ~/.bash_profile
        env | sort
        make all
    - name: Verify
      run: |
        xvfb-run -a dist/Tahoe-LAFS/tahoe --version-and-path
        xvfb-run -a dist/Gridsync/gridsync --version
        xvfb-run -a dist/Gridsync.AppImage --version
    - name: Upload artifacts
      uses: actions/upload-artifact@v2
      with:
        path: dist/Gridsync.AppImage
  macOS:
    strategy:
      fail-fast: false
      matrix:
        os:
          - runs-on: macos-10.15
    runs-on: ${{ matrix.os.runs-on }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Restore pyenv cache
      uses: actions/cache@v2
      with:
        path: ~/.pyenv
        key: pyenv-${{ matrix.os.runs-on }}
        restore-keys: pyenv-${{ matrix.os.runs-on }}
    - name: Restore cargo cache
      uses: actions/cache@v2
      with:
        path: ~/.cargo
        key: cargo-${{ matrix.os.runs-on }}
        restore-keys: cargo-${{ matrix.os.runs-on }}
    - name: Install dependencies
      run: |
        scripts/provision_devtools.sh
    - name: Test
      run: |
        env | sort
        cat ~/.bashrc
        source ~/.bashrc
        env | sort
        make test
    - name: Build
      run: |
        env | sort
        cat ~/.bashrc
        source ~/.bashrc
        env | sort
        make all
    - name: Verify
      run: |
        dist/Gridsync.app/Contents/MacOS/Tahoe-LAFS/tahoe --version-and-path
        dist/Gridsync.app/Contents/MacOS/Gridsync --version
    - name: Upload artifacts
      uses: actions/upload-artifact@v2
      with:
        path: dist/Gridsync.dmg
  Windows:
    strategy:
      fail-fast: false
      matrix:
        os:
          - runs-on: windows-2019
    runs-on: ${{ matrix.os.runs-on }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Install dependencies
      run: |
        scripts/provision_devtools.bat
    - name: Test
      run: |
        .\make.bat test
    - name: Build
      run: .\make.bat all
    - name: Verify
      run: |
        .\dist\Gridsync\Tahoe-LAFS\tahoe.exe --version-and-path
        .\dist\Gridsync\Gridsync.exe --version
    - name: Upload artifacts
      uses: actions/upload-artifact@v2
      with:
        path: .\dist\Gridsync-setup.exe
